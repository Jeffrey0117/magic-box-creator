import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '@/integrations/supabase/client';
import { isAdmin } from '@/lib/admin';
import { toast } from 'sonner';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { LayoutDashboard, Users, Package, History, Search, Eye, Trash2, Edit, UserCog } from 'lucide-react';
import { Tables } from '@/integrations/supabase/types';
import { ProfileEditDialog } from '@/components/ProfileEditDialog';

interface Stats {
  totalUsers: number;
  weeklyUsers: number;
  totalKeywords: number;
  weeklyKeywords: number;
  totalClaims: number;
  todayClaims: number;
  totalCreators: number;
}

type Keyword = Tables<'keywords'> & {
  creator_email?: string;
};

type UserStats = {
  user_id: string;
  email: string;
  display_name: string | null;
  keyword_count: number;
  total_claims: number;
  created_at: string;
};

export default function Admin() {
  const navigate = useNavigate();
  const [stats, setStats] = useState<Stats>({
    totalUsers: 0,
    weeklyUsers: 0,
    totalKeywords: 0,
    weeklyKeywords: 0,
    totalClaims: 0,
    todayClaims: 0,
    totalCreators: 0,
  });
  const [loading, setLoading] = useState(true);
  const [keywords, setKeywords] = useState<Keyword[]>([]);
  const [users, setUsers] = useState<UserStats[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [editingKeyword, setEditingKeyword] = useState<Keyword | null>(null);
  const [editForm, setEditForm] = useState({
    keyword: '',
    content: '',
    quota: '',
    expires_at: '',
    images: ['', '', '', '', ''],
  });
  const [showBatchImageDialog, setShowBatchImageDialog] = useState(false);
  const [batchImageInput, setBatchImageInput] = useState('');
  const [editingUserId, setEditingUserId] = useState<string | null>(null);
  const [editingUserEmail, setEditingUserEmail] = useState<string>('');

  useEffect(() => {
    const checkAuth = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        toast.error('Ë´ãÂÖàÁôªÂÖ•');
        navigate('/login');
        return;
      }
      
      if (!isAdmin(user.email)) {
        toast.error('‚õî Ê¨äÈôê‰∏çË∂≥');
        navigate('/');
        return;
      }

      await Promise.all([fetchStats(), fetchKeywords(), fetchUsers()]);
    };

    checkAuth();
  }, [navigate]);

  const fetchStats = async () => {
    try {
      setLoading(true);

      const { data, error } = await supabase.rpc('get_admin_stats');

      if (error) {
        console.error('Failed to fetch stats:', error);
        toast.error('ËºâÂÖ•Áµ±Ë®àÊï∏ÊìöÂ§±Êïó');
        return;
      }

      if (data) {
        setStats({
          totalUsers: data.total_users || 0,
          weeklyUsers: data.weekly_users || 0,
          totalKeywords: data.total_keywords || 0,
          weeklyKeywords: data.weekly_keywords || 0,
          totalClaims: data.total_claims || 0,
          todayClaims: data.today_claims || 0,
          totalCreators: data.total_creators || 0,
        });
      }
    } catch (error) {
      console.error('Failed to fetch stats:', error);
      toast.error('ËºâÂÖ•Áµ±Ë®àÊï∏ÊìöÂ§±Êïó');
    } finally {
      setLoading(false);
    }
  };

  const fetchKeywords = async () => {
    try {
      const { data, error } = await supabase
        .from('keywords')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      
      const keywordsWithEmailPromises = (data || []).map(async (kw) => {
        const { data: userStat } = await supabase
          .from('user_stats')
          .select('email')
          .eq('user_id', kw.creator_id)
          .single();
        
        return {
          ...kw,
          creator_email: userStat?.email || 'Unknown'
        };
      });
      
      const keywordsWithEmail = await Promise.all(keywordsWithEmailPromises);
      setKeywords(keywordsWithEmail);
    } catch (error) {
      console.error('Failed to fetch keywords:', error);
      toast.error('ËºâÂÖ•Ë≥áÊñôÂåÖÂàóË°®Â§±Êïó');
    }
  };

  const fetchUsers = async () => {
    try {
      const { data, error } = await supabase
        .from('user_stats')
        .select('*');

      if (error) throw error;

      const userStats: UserStats[] = (data || []).map((row: any) => ({
        user_id: row.user_id,
        email: row.email,
        display_name: row.display_name,
        keyword_count: row.keyword_count,
        total_claims: row.total_claims,
        created_at: row.created_at
      }));

      setUsers(userStats);
    } catch (error) {
      console.error('Failed to fetch users:', error);
      toast.error('ËºâÂÖ•Áî®Êà∂ÂàóË°®Â§±Êïó');
    }
  };

  const handleEditKeyword = (kw: Keyword) => {
    setEditingKeyword(kw);
    setEditForm({
      keyword: kw.keyword,
      content: kw.content,
      quota: kw.quota?.toString() || '',
      expires_at: kw.expires_at ? new Date(kw.expires_at).toISOString().slice(0, 16) : '',
      images: [
        ...(kw.images || []),
        ...Array(5 - (kw.images?.length || 0)).fill(''),
      ].slice(0, 5),
    });
  };

  const handleBatchImagePaste = () => {
    const urls = batchImageInput
      .split('\n')
      .map(url => url.trim())
      .filter(url => url !== '')
      .slice(0, 5);
    
    const newImages = [...urls, ...Array(5 - urls.length).fill('')].slice(0, 5);
    setEditForm({ ...editForm, images: newImages });
    setShowBatchImageDialog(false);
    setBatchImageInput('');
    toast.success(`Â∑≤ÂåØÂÖ• ${urls.length} ÂºµÂúñÁâá`);
  };

  const handleSaveEdit = async () => {
    if (!editingKeyword) return;

    try {
      const filteredImages = editForm.images.filter(url => url.trim() !== '');
      
      const { error } = await supabase
        .from('keywords')
        .update({
          keyword: editForm.keyword,
          content: editForm.content,
          quota: editForm.quota ? parseInt(editForm.quota) : null,
          expires_at: editForm.expires_at || null,
          images: filteredImages.length > 0 ? filteredImages : null,
        })
        .eq('id', editingKeyword.id);

      if (error) throw error;

      toast.success('Ë≥áÊñôÂåÖÂ∑≤Êõ¥Êñ∞');
      setEditingKeyword(null);
      fetchKeywords();
    } catch (error) {
      console.error('Failed to update keyword:', error);
      toast.error('Êõ¥Êñ∞Â§±Êïó');
    }
  };

  const handleDeleteKeyword = async (id: string) => {
    if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë≥áÊñôÂåÖÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) return;

    try {
      const { error } = await supabase.from('keywords').delete().eq('id', id);
      if (error) throw error;
      
      toast.success('Ë≥áÊñôÂåÖÂ∑≤Âà™Èô§');
      fetchKeywords();
      fetchStats();
    } catch (error) {
      console.error('Failed to delete keyword:', error);
      toast.error('Âà™Èô§Â§±Êïó');
    }
  };

  const getUserStatus = (keywordCount: number, totalClaims: number) => {
    if (keywordCount >= 3 && totalClaims >= 50) {
      return { label: 'üü¢ Ê¥ªË∫ç', variant: 'default' as const };
    }
    if (keywordCount > 0) {
      return { label: 'üü° ‰∏ÄËà¨', variant: 'secondary' as const };
    }
    return { label: 'üîµ È†òÂèñËÄÖ', variant: 'outline' as const };
  };

  const getPackageStatus = (currentCount: number, quota: number | null) => {
    if (quota === null) return { label: 'üîÑ ÈÄ≤Ë°å‰∏≠', variant: 'secondary' as const };
    if (currentCount >= quota) return { label: '‚úÖ Â∑≤ÂÆåÊàê', variant: 'default' as const };
    if (currentCount >= quota * 0.8) return { label: 'üü° Âç≥Â∞áÂÆåÊàê', variant: 'default' as const };
    if (currentCount === 0) return { label: '‚è∏Ô∏è Êú™ÂïüÁî®', variant: 'outline' as const };
    return { label: 'üîÑ ÈÄ≤Ë°å‰∏≠', variant: 'secondary' as const };
  };

  const filteredUsers = users.filter(u =>
    u.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
    (u.display_name && u.display_name.toLowerCase().includes(searchTerm.toLowerCase()))
  );

  const filteredKeywords = keywords.filter(k =>
    k.keyword.toLowerCase().includes(searchTerm.toLowerCase()) ||
    k.short_code?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    k.creator_email?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-gradient-to-b from-background to-secondary/20 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="mb-8">
          <h1 className="text-4xl font-bold mb-2">üîê Admin ÂæåÂè∞</h1>
          <p className="text-muted-foreground">KeyBox Âπ≥Âè∞ÁÆ°ÁêÜÁ≥ªÁµ±</p>
        </div>

        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-8">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Á∏ΩÁî®Êà∂Êï∏</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{loading ? '...' : stats.totalUsers}</div>
              <p className="text-xs text-muted-foreground">Êú¨ÈÄ±Êñ∞Â¢ûÔºö{loading ? '...' : stats.weeklyUsers}</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Á∏ΩË≥áÊñôÂåÖ</CardTitle>
              <Package className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{loading ? '...' : stats.totalKeywords}</div>
              <p className="text-xs text-muted-foreground">Êú¨ÈÄ±Êñ∞Â¢ûÔºö{loading ? '...' : stats.weeklyKeywords}</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Á∏ΩÈ†òÂèñÊ¨°Êï∏</CardTitle>
              <History className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{loading ? '...' : stats.totalClaims}</div>
              <p className="text-xs text-muted-foreground">‰ªäÊó•Ôºö{loading ? '...' : stats.todayClaims}</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ââµ‰ΩúËÄÖÊï∏Èáè</CardTitle>
              <LayoutDashboard className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{loading ? '...' : stats.totalCreators}</div>
              <p className="text-xs text-muted-foreground">Ê¥ªË∫çÂâµ‰ΩúËÄÖ</p>
            </CardContent>
          </Card>
        </div>

        <Tabs defaultValue="dashboard" className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="dashboard">üìä Áµ±Ë®àÁ∏ΩË¶Ω</TabsTrigger>
            <TabsTrigger value="users">üë• Áî®Êà∂ÁÆ°ÁêÜ</TabsTrigger>
            <TabsTrigger value="packages">üì¶ Ë≥áÊñôÂåÖÁÆ°ÁêÜ</TabsTrigger>
          </TabsList>

          <TabsContent value="dashboard" className="space-y-4 mt-6">
            <Card>
              <CardHeader>
                <CardTitle>‚úÖ ÂäüËÉΩÊ∏ÖÂñÆ</CardTitle>
                <CardDescription>Admin ÂæåÂè∞Á≥ªÁµ±ÂäüËÉΩ</CardDescription>
              </CardHeader>
              <CardContent>
                <ul className="space-y-2 text-sm">
                  <li>‚úÖ Ê¨äÈôê‰øùË≠∑Ê©üÂà∂</li>
                  <li>‚úÖ Áî®Êà∂Áµ±Ë®àÊï∏ÊìöÔºàÁ∏ΩÊï∏„ÄÅÊú¨ÈÄ±Êñ∞Â¢ûÔºâ</li>
                  <li>‚úÖ Ë≥áÊñôÂåÖÁµ±Ë®àÊï∏ÊìöÔºàÁ∏ΩÊï∏„ÄÅÊú¨ÈÄ±Êñ∞Â¢ûÔºâ</li>
                  <li>‚úÖ È†òÂèñË®òÈåÑÁµ±Ë®àÔºàÁ∏ΩÊï∏„ÄÅ‰ªäÊó•Êñ∞Â¢ûÔºâ</li>
                  <li>‚úÖ Ââµ‰ΩúËÄÖÊï∏ÈáèÁµ±Ë®à</li>
                  <li>‚úÖ Áî®Êà∂ÁÆ°ÁêÜÂäüËÉΩ</li>
                  <li>‚úÖ Ë≥áÊñôÂåÖÂàóË°®ÁÆ°ÁêÜ</li>
                </ul>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="users" className="space-y-4 mt-6">
            <Card>
              <CardHeader>
                <CardTitle>üë• Áî®Êà∂ÁÆ°ÁêÜ</CardTitle>
                <CardDescription>Êü•ÁúãÂíåÁÆ°ÁêÜÊâÄÊúâÁî®Êà∂</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex items-center gap-2 mb-4">
                  <Search className="h-4 w-4 text-gray-400" />
                  <Input
                    placeholder="ÊêúÂ∞ã Email ÊàñÊö±Á®±..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="max-w-sm"
                  />
                </div>

                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Email</TableHead>
                      <TableHead>Êö±Á®±</TableHead>
                      <TableHead>Ë≥áÊñôÂåÖÊï∏</TableHead>
                      <TableHead>Á∏ΩÈ†òÂèñÊ¨°Êï∏</TableHead>
                      <TableHead>Âä†ÂÖ•ÊôÇÈñì</TableHead>
                      <TableHead>ÁãÄÊÖã</TableHead>
                      <TableHead className="text-right">Êìç‰Ωú</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredUsers.length === 0 ? (
                      <TableRow>
                        <TableCell colSpan={7} className="text-center text-gray-500">
                          Ê≤íÊúâË≥áÊñô
                        </TableCell>
                      </TableRow>
                    ) : (
                      filteredUsers.map((user) => {
                        const status = getUserStatus(user.keyword_count, user.total_claims);
                        return (
                          <TableRow key={user.user_id}>
                            <TableCell className="font-mono text-sm">{user.email}</TableCell>
                            <TableCell>{user.display_name || '(Êú™Ë®≠ÂÆö)'}</TableCell>
                            <TableCell>{user.keyword_count}</TableCell>
                            <TableCell>{user.total_claims}</TableCell>
                            <TableCell>{new Date(user.created_at).toLocaleDateString('zh-TW')}</TableCell>
                            <TableCell>
                              <Badge variant={status.variant}>{status.label}</Badge>
                            </TableCell>
                            <TableCell className="text-right">
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => {
                                  setEditingUserId(user.user_id);
                                  setEditingUserEmail(user.email);
                                }}
                              >
                                <UserCog className="h-4 w-4" />
                              </Button>
                            </TableCell>
                          </TableRow>
                        );
                      })
                    )}
                  </TableBody>
                </Table>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="packages" className="space-y-4 mt-6">
            <Card>
              <CardHeader>
                <CardTitle>üì¶ Ë≥áÊñôÂåÖÁÆ°ÁêÜ</CardTitle>
                <CardDescription>Êü•ÁúãÂíåÁÆ°ÁêÜÊâÄÊúâË≥áÊñôÂåÖ</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex items-center gap-2 mb-4">
                  <Search className="h-4 w-4 text-gray-400" />
                  <Input
                    placeholder="ÊêúÂ∞ãÈóúÈçµÂ≠ó„ÄÅÁü≠Á¢ºÊàñÂâµ‰ΩúËÄÖ..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="max-w-sm"
                  />
                </div>

                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>ÈóúÈçµÂ≠ó</TableHead>
                      <TableHead>Áü≠Á¢º</TableHead>
                      <TableHead>Ââµ‰ΩúËÄÖ</TableHead>
                      <TableHead>È†òÂèñÈÄ≤Â∫¶</TableHead>
                      <TableHead>ÁãÄÊÖã</TableHead>
                      <TableHead className="text-right">Êìç‰Ωú</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredKeywords.length === 0 ? (
                      <TableRow>
                        <TableCell colSpan={6} className="text-center text-gray-500">
                          Ê≤íÊúâË≥áÊñô
                        </TableCell>
                      </TableRow>
                    ) : (
                      filteredKeywords.map((kw) => {
                        const status = getPackageStatus(kw.current_count, kw.quota);
                        const progress = kw.quota 
                          ? `${kw.current_count}/${kw.quota} (${Math.round((kw.current_count / kw.quota) * 100)}%)`
                          : `${kw.current_count}/‚àû`;
                        
                        return (
                          <TableRow key={kw.id}>
                            <TableCell className="font-medium">{kw.keyword}</TableCell>
                            <TableCell>
                              <code className="text-xs bg-emerald-100 text-emerald-800 px-2 py-1 rounded font-mono">
                                {kw.short_code}
                              </code>
                            </TableCell>
                            <TableCell className="text-sm text-gray-600">{kw.creator_email}</TableCell>
                            <TableCell>{progress}</TableCell>
                            <TableCell>
                              <Badge variant={status.variant}>{status.label}</Badge>
                            </TableCell>
                            <TableCell className="text-right space-x-2">
                              <Dialog>
                                <DialogTrigger asChild>
                                  <Button variant="ghost" size="sm">
                                    <Eye className="h-4 w-4" />
                                  </Button>
                                </DialogTrigger>
                                <DialogContent className="max-w-2xl">
                                  <DialogHeader>
                                    <DialogTitle>üì¶ {kw.keyword}</DialogTitle>
                                  </DialogHeader>
                                  <div className="space-y-4">
                                    <div className="bg-secondary/30 p-4 rounded-lg">
                                      <p className="text-sm text-muted-foreground mb-2">Áü≠Á¢ºÔºö{kw.short_code}</p>
                                      <p className="text-sm text-muted-foreground mb-2">Ââµ‰ΩúËÄÖÔºö{kw.creator_email}</p>
                                      <p className="text-sm text-muted-foreground mb-2">È†òÂèñÈÄ≤Â∫¶Ôºö{progress}</p>
                                      {kw.expires_at && (
                                        <p className="text-sm text-muted-foreground mb-2">
                                          ÈÅéÊúüÊôÇÈñìÔºö{new Date(kw.expires_at).toLocaleString('zh-TW')}
                                        </p>
                                      )}
                                      {kw.images && kw.images.length > 0 && (
                                        <div>
                                          <p className="text-sm text-muted-foreground mb-2">ÂúñÁâáÊï∏ÈáèÔºö{kw.images.length}</p>
                                        </div>
                                      )}
                                    </div>
                                    <div className="bg-secondary/30 p-4 rounded-lg">
                                      <p className="text-sm font-medium mb-2">Ë≥áÊñôÂåÖÂÖßÂÆπÔºö</p>
                                      <pre className="whitespace-pre-wrap text-sm">{kw.content}</pre>
                                    </div>
                                  </div>
                                </DialogContent>
                              </Dialog>
                              <Dialog open={editingKeyword?.id === kw.id} onOpenChange={(open) => !open && setEditingKeyword(null)}>
                                <DialogTrigger asChild>
                                  <Button variant="ghost" size="sm" onClick={() => handleEditKeyword(kw)}>
                                    <Edit className="h-4 w-4" />
                                  </Button>
                                </DialogTrigger>
                                <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
                                  <DialogHeader>
                                    <DialogTitle>‚úèÔ∏è Á∑®ËºØË≥áÊñôÂåÖ</DialogTitle>
                                  </DialogHeader>
                                  <div className="space-y-4">
                                    <div>
                                      <Label htmlFor="edit-keyword">ÈóúÈçµÂ≠ó</Label>
                                      <Input
                                        id="edit-keyword"
                                        value={editForm.keyword}
                                        onChange={(e) => setEditForm({ ...editForm, keyword: e.target.value })}
                                      />
                                    </div>
                                    <div>
                                      <Label htmlFor="edit-content">Ë≥áÊñôÂåÖÂÖßÂÆπ</Label>
                                      <Textarea
                                        id="edit-content"
                                        value={editForm.content}
                                        onChange={(e) => setEditForm({ ...editForm, content: e.target.value })}
                                        rows={5}
                                      />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                      <div>
                                        <Label htmlFor="edit-quota">ÈÖçÈ°çÈôêÂà∂ÔºàÈÅ∏Â°´Ôºâ</Label>
                                        <Input
                                          id="edit-quota"
                                          type="number"
                                          placeholder="‰∏çÈôêÂà∂"
                                          value={editForm.quota}
                                          onChange={(e) => setEditForm({ ...editForm, quota: e.target.value })}
                                        />
                                      </div>
                                      <div>
                                        <Label htmlFor="edit-expires">ÈÅéÊúüÊôÇÈñìÔºàÈÅ∏Â°´Ôºâ</Label>
                                        <Input
                                          id="edit-expires"
                                          type="datetime-local"
                                          value={editForm.expires_at}
                                          onChange={(e) => setEditForm({ ...editForm, expires_at: e.target.value })}
                                        />
                                      </div>
                                    </div>
                                    <div>
                                      <div className="flex items-center justify-between mb-2">
                                        <Label>ÂúñÁâá URLÔºàÊúÄÂ§ö 5 ÂºµÔºåÈÅ∏Â°´Ôºâ</Label>
                                        <Dialog open={showBatchImageDialog} onOpenChange={setShowBatchImageDialog}>
                                          <DialogTrigger asChild>
                                            <Button variant="outline" size="sm" type="button">
                                              üìã ÊâπÈáèË≤ºÂÖ•
                                            </Button>
                                          </DialogTrigger>
                                          <DialogContent>
                                            <DialogHeader>
                                              <DialogTitle>ÊâπÈáèË≤ºÂÖ•ÂúñÁâá URL</DialogTitle>
                                            </DialogHeader>
                                            <div className="space-y-4">
                                              <Label htmlFor="batch-images">ÊØèË°å‰∏ÄÂÄã URLÔºàÊúÄÂ§ö 5 ÂÄãÔºâ</Label>
                                              <Textarea
                                                id="batch-images"
                                                placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg&#10;https://example.com/image3.jpg"
                                                value={batchImageInput}
                                                onChange={(e) => setBatchImageInput(e.target.value)}
                                                rows={8}
                                              />
                                              <div className="flex justify-end gap-2">
                                                <Button variant="outline" onClick={() => {
                                                  setShowBatchImageDialog(false);
                                                  setBatchImageInput('');
                                                }}>
                                                  ÂèñÊ∂à
                                                </Button>
                                                <Button onClick={handleBatchImagePaste}>
                                                  Á¢∫ÂÆöÂåØÂÖ•
                                                </Button>
                                              </div>
                                            </div>
                                          </DialogContent>
                                        </Dialog>
                                      </div>
                                      {editForm.images.map((url, idx) => (
                                        <Input
                                          key={idx}
                                          placeholder={`ÂúñÁâá ${idx + 1} URL`}
                                          value={url}
                                          onChange={(e) => {
                                            const newImages = [...editForm.images];
                                            newImages[idx] = e.target.value;
                                            setEditForm({ ...editForm, images: newImages });
                                          }}
                                          className="mt-2"
                                        />
                                      ))}
                                    </div>

                                    <div className="flex justify-end gap-2 mt-4">
                                      <Button variant="outline" onClick={() => setEditingKeyword(null)}>
                                        ÂèñÊ∂à
                                      </Button>
                                      <Button onClick={handleSaveEdit}>
                                        ÂÑ≤Â≠ò
                                      </Button>
                                    </div>
                                  </div>
                                </DialogContent>
                              </Dialog>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => navigate(`/admin/packages/${kw.short_code}`)}
                              >
                                Êü•ÁúãË©≥ÊÉÖ
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => handleDeleteKeyword(kw.id)}
                              >
                                <Trash2 className="h-4 w-4 text-red-500" />
                              </Button>
                            </TableCell>
                          </TableRow>
                        );
                      })
                    )}
                  </TableBody>
                </Table>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {editingUserId && (
          <ProfileEditDialog
            open={!!editingUserId}
            onOpenChange={(open) => {
              if (!open) {
                setEditingUserId(null);
                setEditingUserEmail('');
                fetchUsers();
              }
            }}
            userId={editingUserId}
            userEmail={editingUserEmail}
          />
        )}
      </div>
    </div>
  );
}