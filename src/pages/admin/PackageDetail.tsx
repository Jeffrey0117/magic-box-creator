import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '@/integrations/supabase/client';
import { isAdmin } from '@/lib/admin';
import { toast } from 'sonner';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import { Tables } from '@/integrations/supabase/types';

type Keyword = Tables<'keywords'>;

interface PackageAnalytics {
  total_claims: number;
  first_claim: string | null;
  last_claim: string | null;
  daily_stats: Array<{
    date: string;
    count: number;
  }> | null;
}

export default function PackageDetail() {
  const { packageId } = useParams<{ packageId: string }>();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [packageData, setPackageData] = useState<Keyword | null>(null);
  const [analytics, setAnalytics] = useState<PackageAnalytics | null>(null);
  const [creatorEmail, setCreatorEmail] = useState<string>('');

  useEffect(() => {
    const checkAuth = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        toast.error('è«‹å…ˆç™»å…¥');
        navigate('/login');
        return;
      }
      
      if (!isAdmin(user.email)) {
        toast.error('â›” æ¬Šé™ä¸è¶³');
        navigate('/admin');
        return;
      }

      await fetchPackageData();
    };

    checkAuth();
  }, [packageId, navigate]);

  const fetchPackageData = async () => {
    if (!packageId) return;
    
    try {
      setLoading(true);

      const { data: keyword, error: keywordError } = await supabase
        .from('keywords')
        .select('*')
        .eq('id', packageId)
        .single();

      if (keywordError) throw keywordError;
      setPackageData(keyword);

      const { data: userStat } = await supabase
        .from('user_stats')
        .select('email')
        .eq('user_id', keyword.creator_id)
        .single();

      setCreatorEmail(userStat?.email || 'Unknown');

      const { data: analyticsData, error: analyticsError } = await supabase
        .rpc('get_package_analytics', { package_id: packageId });

      if (analyticsError) {
        console.error('Analytics error:', analyticsError);
      } else {
        setAnalytics(analyticsData);
      }
    } catch (error) {
      console.error('Failed to fetch package data:', error);
      toast.error('è¼‰å…¥è³‡æ–™å¤±æ•—');
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateString: string | null) => {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleString('zh-TW');
  };

  const calculateCompletionTime = () => {
    if (!packageData || !analytics || !packageData.quota) return null;
    if (packageData.current_count < packageData.quota) return 'é€²è¡Œä¸­';
    if (!analytics.first_claim || !analytics.last_claim) return '-';

    const start = new Date(packageData.created_at).getTime();
    const end = new Date(analytics.last_claim).getTime();
    const diff = end - start;
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    
    return `${days}å¤©${hours}å°æ™‚`;
  };

  const calculateDailyAverage = () => {
    if (!packageData || !analytics) return 0;
    const now = new Date().getTime();
    const created = new Date(packageData.created_at).getTime();
    const days = Math.max((now - created) / (1000 * 60 * 60 * 24), 1);
    return (packageData.current_count / days).toFixed(1);
  };

  const getPeakClaim = () => {
    if (!analytics?.daily_stats || analytics.daily_stats.length === 0) return '-';
    const peak = analytics.daily_stats.reduce((max, stat) => 
      stat.count > max.count ? stat : max
    , analytics.daily_stats[0]);
    return `${peak.count} (${new Date(peak.date).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' })})`;
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-emerald-50 to-white p-6">
        <div className="max-w-7xl mx-auto">
          <div className="text-center py-12">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    );
  }

  if (!packageData) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-emerald-50 to-white p-6">
        <div className="max-w-7xl mx-auto">
          <div className="text-center py-12">æ‰¾ä¸åˆ°è³‡æ–™åŒ…</div>
        </div>
      </div>
    );
  }

  const completionPercentage = packageData.quota 
    ? Math.round((packageData.current_count / packageData.quota) * 100)
    : 0;

  return (
    <div className="min-h-screen bg-gradient-to-b from-emerald-50 to-white p-6">
      <div className="max-w-7xl mx-auto">
        <Button
          variant="ghost"
          onClick={() => navigate('/admin')}
          className="mb-6"
        >
          <ArrowLeft className="w-4 h-4 mr-2" />
          è¿”å›å¾Œå°
        </Button>

        <Card className="mb-6">
          <CardHeader>
            <CardTitle className="text-2xl">ğŸ“¦ {packageData.keyword}</CardTitle>
            <CardDescription>
              çŸ­ç¶²å€ï¼š{window.location.origin}/{packageData.short_code || packageData.id}
              <br />
              å‰µä½œè€…ï¼š{creatorEmail}
              <br />
              å»ºç«‹æ™‚é–“ï¼š{formatDate(packageData.created_at)}
            </CardDescription>
          </CardHeader>
        </Card>

        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-6">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">ç¸½é ˜å–æ¬¡æ•¸</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{packageData.current_count}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">é¡åº¦è¨­å®š</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{packageData.quota || 'âˆ'}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">å®Œæˆåº¦</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                {packageData.quota ? `${completionPercentage}%` : '-'}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">å®Œæˆç”¨æ™‚</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{calculateCompletionTime()}</div>
            </CardContent>
          </Card>
        </div>

        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-6">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">é¦–æ¬¡é ˜å–æ™‚é–“</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-sm">
                {analytics?.first_claim 
                  ? new Date(analytics.first_claim).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                  : '-'
                }
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">æœ€å¾Œé ˜å–æ™‚é–“</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-sm">
                {analytics?.last_claim 
                  ? new Date(analytics.last_claim).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                  : '-'
                }
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">å¹³å‡æ¯æ—¥é ˜å–</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{calculateDailyAverage()}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">å³°å€¼é ˜å–</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-xl font-bold">{getPeakClaim()}</div>
            </CardContent>
          </Card>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>ğŸ“„ è³‡æ–™åŒ…å…§å®¹</CardTitle>
          </CardHeader>
          <CardContent>
            <pre className="whitespace-pre-wrap bg-emerald-50 p-4 rounded-lg text-sm text-gray-800">
              {packageData.content}
            </pre>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}